String.prototype.hashCode=function(){var a=0,b,c;if(0==this.length)return a;b=0;for(l=this.length;b<l;b++)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a};var alarmRun=0;function install_notice(){var a=chrome.runtime.getManifest();if(localStorage.version!=a.version){var b=(new Date).getTime();localStorage.install_time=b;localStorage.version=a.version;chrome.tabs.create({url:"options.html#about"})}}install_notice();var hashes=[];
document.addEventListener("DOMContentLoaded",function(){chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1})});
chrome.alarms.onAlarm.addListener(function(a){var b=chrome.extension.getViews({type:"popup"});"feed"==a.name&&(b.length||$.get("http://soundation.com/feed",function(a){a=a.replace(/<img\b[^>]*>/ig,"").replace(/<span class=\"time\">.*<\/span>/ig,"");var b=$(a);a=b.find(".email").text();var s=a.hashCode();"undefined"==typeof localStorage[a]&&(localStorage[a]=s,localStorage[s+".desktop_notifs"]="on");var m=b.find("aside")[0];"undefined"==typeof m&&(chrome.browserAction.setTitle({title:"Please login to view notifications"}),
chrome.browserAction.setBadgeBackgroundColor({color:"#9a9a9a"}),chrome.browserAction.setBadgeText({text:"?"}));var m=m.outerHTML,v=String(m.hashCode()),b=b.find("a[href='/feed']")[0].innerText.match(/(\d+)/);if(null!=b){var w=0,t=[];$(m).find("a.author").each(function(){author=$(this).text();-1==t.indexOf(author)&&t.push(author);++w});for(var m=t.length,q=m-3,n=0,r=w+" new from ",n=0;2>n&&n<m-1;++n)r+=t[n]+", ";r+=t[n];0<q&&(r+=", plus "+q+" other"+(1<q?"s":""));console.log(r);chrome.browserAction.setTitle({title:r});
chrome.browserAction.setBadgeBackgroundColor({color:"#d00"});chrome.browserAction.setBadgeText({text:b[0]});-1==hashes.indexOf(v)&&doNotifs(s)&&chrome.notifications.create(v,{type:"basic",iconUrl:"img/iconapp.png",title:"Soundation Notifications",message:b[0]+" new notification"+(1<parseInt(b[0])?"s":""),contextMessage:r.replace(/\d* new /,"")},function(a){hashes.push(v)})}else console.log("modation: no notifs"),chrome.browserAction.setTitle({title:"No new notifications :("}),chrome.browserAction.setBadgeText({text:""});
check_watchlist(a,!0)}))});function add_watchlist(a,b){chrome.storage.local.get(a,function(c){var u=!0;$.each(c[a].watchlist,function(a,c){return c.link==b?u=!1:!0});u&&(c[a].watchlist.push({link:b}),update_storage(a,c[a]))})}
function check_watchlist(a,b,c){"undefined"==typeof b&&(b=!0);"undefined"==typeof c&&(c=function(){});var u=[];crapi.clone(function(s){function m(){var q=[];$.each(u,function(a,b){var n=b.link,c=$(b.html),g={},e={state:{}};delete b.html;var h=n.match(/user\/.*\/track\//)?!0:!1,k=n.match(/group\/.*/)?!0:!1,d=c.find(".comment .actions").children(".flag, .delete").first();if(d.length){var f;switch(d.attr("class")){case "flag":f=d.attr("onclick");break;case "delete":f=d.attr("href")}"undefined"!=typeof f&&
(g.comment=f.match(/(\d+)/g)[0])}h?(g.title=c.find("#main .title").text(),g.likes=c.find(".stats .likes").text(),g.downloads=c.find(".stats .downloads").text()):k&&(g.title=c.find("#group-info h2").html(),c=c.find("#group-info .info").text(),g.members=c.match(/(\d*) member/)[1],g.following=c.match(/(\d*) follower/)[1]);k=g.title;f=g.likes;d=g.downloads;h=g.members;c=g.following;g=g.comment;e.changes=[];k&&(console.log("title hook"),e.title=k,e.state.title=k);if(f&&b.likes!=f){console.log("likes hook");
var p=f-b.likes,m=p;0<p&&(m="+"+p);e.state.likes=f;k="undefined"==typeof b.likes;if(!isNaN(p)||k)console.log("likes hook nan"),k&&(p=m=f),e.likes=m+" like"+(1<Math.abs(p)||0==p?"s":""),e.changes.push(m+" like"+(1<Math.abs(p)||0==p?"s":""))}d&&b.downloads!=d&&(console.log("downloads hook"),f=d-b.downloads,p="+"+f,e.state.downloads=d,k="undefined"==typeof b.downloads,!isNaN(f)||k)&&(console.log("downloads hook nan"),k&&(f=p=d),e.downloads=p+" download"+(1<f?"s":""),e.changes.push(p+" download"+(1<f?
"s":"")));h&&b.members!=h&&(console.log("members hook"),f=d=h-b.members,0<d&&(f="+"+d),e.state.members=h,k="undefined"==typeof b.members,!isNaN(d)||k)&&(console.log("members hook nan"),k&&(d=f=h),e.members=f+" member"+(1<Math.abs(d)||0==d?"s":""),e.changes.push(f+" member"+(1<Math.abs(d)||0==d?"s":"")));c&&b.following!=c&&(console.log("following hook"),d=h=c-b.following,0<h&&(d="+"+h),e.state.following=c,k="undefined"==typeof b.following,isNaN(h)&&"undefined"!=typeof b.following||(console.log("following hook nan"),
k&&(h=d=c),e.following=d+" follower"+(1<Math.abs(h)||0==h?"s":""),e.changes.push(d+" follower"+(1<Math.abs(h)||0==h?"s":""))));g&&b.comment!=g&&(console.log("comment hook"),console.log("comment hook nan"),e.comment="New comment",e.changes.push("New comment"),e.state.comment=g);console.log(e);e.changes.length&&(console.log("changes hook"),e.link=n,e.index=a,q.push(e))});s[a]["watchlist-queue"]=q;console.log(q);console.log(s[a]);var n="MODATION WATCHLIST\n----------------\n\n";$.each(q,function(b,a){n+=
a.title+" has changes!\n"+a.changes.join(", ")+"\n\n";var c=String(JSON.stringify(a).hashCode());-1==hashes.indexOf(c)&&chrome.notifications.create(c,{type:"basic",iconUrl:"img/iconapp.png",title:"Modation Watchlist",message:a.title,contextMessage:a.changes.join(", ")},function(a){hashes.push(c)})});n+="END OF WATCHLIST";q.length&&console.debug("final iteration complete!");b?crapi.update(a,s[a],c):c()}var v=s[a].watchlist,w=v.length,t=0;$.each(v,function(a,b){$.get("http://soundation.com/"+b.link,
function(c){b.html=c;u[a]=b}).fail(function(){b.fail=!0;u[a]=b}).done(function(){delete b.fail}).always(function(){t++;t==w&&(console.debug("final check complete!"),m())})})})}function update_storage(a,b){var c={};c[a]=b;chrome.storage.local.set(c)}function doNotifs(a){return"undefined"!=typeof a&&"on"!=localStorage[a+".desktop_notifs"]&&"off"==localStorage[a+".desktop_notifs"]?!1:!0};