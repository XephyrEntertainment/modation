String.prototype.hashCode=function(){var a=0,b,c;if(0==this.length)return a;b=0;for(l=this.length;b<l;b++)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a};var alarmRun=0;function install_notice(){var a=chrome.runtime.getManifest();if(localStorage.version!=a.version){var b=(new Date).getTime();localStorage.install_time=b;localStorage.version=a.version;chrome.tabs.create({url:"options.html#about"})}}install_notice();var hashes=[];
document.addEventListener("DOMContentLoaded",function(){chrome.alarms.create("feed",{delayInMinutes:modapi.debug?0:1,periodInMinutes:1})});
chrome.alarms.onAlarm.addListener(function(a){var b=chrome.extension.getViews({type:"popup"});"feed"==a.name&&(b.length||$.get("http://soundation.com/feed",function(a){a=a.replace(/<img\b[^>]*>/ig,"").replace(/<span class=\"time\">.*<\/span>/ig,"");var b=$(a);a=b.find(".email").text();var r=a.hashCode();"undefined"==typeof localStorage[a]&&(localStorage[a]=r,localStorage[r+".desktop_notifs"]="on");var m=b.find("aside")[0];"undefined"==typeof m&&(chrome.browserAction.setTitle({title:"Please login to view notifications"}),
chrome.browserAction.setBadgeBackgroundColor({color:"#9a9a9a"}),chrome.browserAction.setBadgeText({text:"?"}));var m=m.outerHTML,u=String(m.hashCode()),b=b.find("a[href='/feed']")[0].innerText.match(/(\d+)/);if(null!=b){var v=0,s=[];$(m).find("a.author").each(function(){author=$(this).text();-1==s.indexOf(author)&&s.push(author);++v});for(var m=s.length,p=m-3,k=0,q=v+" new from ",k=0;2>k&&k<m-1;++k)q+=s[k]+", ";q+=s[k];0<p&&(q+=", plus "+p+" other"+(1<p?"s":""));console.log(q);chrome.browserAction.setTitle({title:q});
chrome.browserAction.setBadgeBackgroundColor({color:"#d00"});chrome.browserAction.setBadgeText({text:b[0]});-1==hashes.indexOf(u)&&doNotifs(r)&&chrome.notifications.create(u,{type:"basic",iconUrl:"img/iconapp.png",title:"Soundation Notifications",message:b[0]+" new notification"+(1<parseInt(b[0])?"s":""),contextMessage:q.replace(/\d* new /,"")},function(a){hashes.push(u)})}else console.log("modation: no notifs"),chrome.browserAction.setTitle({title:"No new notifications :("}),chrome.browserAction.setBadgeText({text:""});
check_watchlist(a,!0)}))});function add_watchlist(a,b){chrome.storage.local.get(a,function(c){var t=!0;$.each(c[a].watchlist,function(a,c){return c.link==b?t=!1:!0});t&&(c[a].watchlist.push({link:b}),update_storage(a,c[a]))})}
function check_watchlist(a,b,c){"undefined"==typeof b&&(b=!0);"undefined"==typeof c&&(c=function(){});var t=[];chrome.storage.local.get(a,function(r){function m(){var p=[];$.each(t,function(a,b){var k=b.link,c=$(b.html),h={},d={state:{}};delete b.html;var n=k.match(/user\/.*\/track\//)?!0:!1,f=k.match(/group\/.*/)?!0:!1,g=c.find(".comment .actions").children(".flag, .delete").first();if(g.length){var e;switch(g.attr("class")){case "flag":e=g.attr("onclick");break;case "delete":e=g.attr("href")}"undefined"!=
typeof e&&(h.comment=e.match(/(\d+)/g)[0])}n?(h.title=c.find("#main .title").text(),h.likes=c.find(".stats .likes").text(),h.downloads=c.find(".stats .downloads").text()):f&&(h.title=c.find("#group-info h2").html(),c=c.find("#group-info .info").text(),h.members=c.match(/(\d*) member/)[1],h.following=c.match(/(\d*) follower/)[1]);e=h.title;g=h.likes;f=h.downloads;n=h.members;c=h.following;h=h.comment;d.changes=[];e&&(d.title=e,d.state.title=e);if(g&&b.likes!=g){var m=e=g-b.likes;0<e&&(m="+"+e);d.state.likes=
g;isNaN(e)||(d.likes=m+" like"+(1<e||-1>e?"s":""),d.changes.push(m+" like"+(1<e||-1>e?"s":"")))}f&&b.downloads!=f&&(g=f-b.downloads,e="+"+g,d.state.downloads=f,isNaN(g)||(d.downloads=e+" download"+(1<g?"s":""),d.changes.push(e+" download"+(1<g?"s":""))));n&&b.members!=n&&(g=f=n-b.members,0<f&&(g="+"+f),d.state.members=n,isNaN(f)||(d.members=g+" members"+(1<f||-1>f?"s":""),d.changes.push(g+" members"+(1<f||-1>f?"s":""))));c&&b.following!=c&&(f=n=c-b.following,0<n&&(f="+"+n),d.state.following=c,isNaN(n)||
(d.following=f+" follower"+(1<n||-1>n?"s":""),d.changes.push(f+" follower"+(1<n||-1>n?"s":""))));h&&b.comment!=h&&("undefined"!=typeof b.comment&&(d.comment="New comment",d.changes.push("New comment")),d.state.comment=h);d.changes.length&&(d.link=k,d.index=a,p.push(d))});r[a]["watchlist-queue"]=p;console.log(p);console.log(r[a]);var k="MODATION WATCHLIST\n----------------\n\n";$.each(p,function(a,b){k+=b.title+" has changes!\n"+b.changes.join(", ")+"\n\n";var c=String(JSON.stringify(b).hashCode());
-1==hashes.indexOf(c)&&chrome.notifications.create(c,{type:"basic",iconUrl:"img/iconapp.png",title:"Modation Watchlist",message:b.title,contextMessage:b.changes.join(", ")},function(b){hashes.push(c)})});k+="END OF WATCHLIST";p.length&&console.debug("final iteration complete!");b?update_storage(a,r[a],c):c()}var u=r[a].watchlist,v=u.length,s=0;$.each(u,function(b,a){$.get("http://soundation.com/"+a.link,function(c){a.html=c;t[b]=a}).fail(function(){a.fail=!0;t[b]=a}).done(function(){delete a.fail}).always(function(){s++;
s==v&&(console.debug("final check complete!"),m())})})})}function update_storage(a,b){var c={};c[a]=b;chrome.storage.local.set(c)}function doNotifs(a){return"undefined"!=typeof a&&"on"!=localStorage[a+".desktop_notifs"]&&"off"==localStorage[a+".desktop_notifs"]?!1:!0};