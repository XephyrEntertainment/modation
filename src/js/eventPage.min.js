String.prototype.hashCode=function(){var a=0,c,n;if(0==this.length)return a;c=0;for(l=this.length;c<l;c++)n=this.charCodeAt(c),a=(a<<5)-a+n,a|=0;return a};var alarmRunning=!1;function install_notice(){var a=chrome.runtime.getManifest();if(localStorage.version!=a.version){var c=(new Date).getTime();localStorage.install_time=c;localStorage.version=a.version;chrome.tabs.create({url:"options.html#about"})}}install_notice();var hashes=[];
document.addEventListener("DOMContentLoaded",function(){chrome.alarms.create("feed",{delayInMinutes:modapi.manifest.debug?0:1,periodInMinutes:1})});chrome.runtime.onMessage.addListener(function(a,c,n){"modation-pause-everything"==a.action&&chrome.tabs.query({url:"http://*.soundation.com/*"},function(c){$.each(c,function(c,m){chrome.tabs.sendMessage(m.id,{action:"modation-pause",guid:a.guid},function(a){})})})});
chrome.alarms.onAlarm.addListener(function(a){var c=chrome.extension.getViews({type:"popup"});crapi.clone(function(n){modapi.login(function(m){"feed"==a.name&&(alarmRunning?console.info("Alarm running, notification handler cancelled"):c.length?console.info("Popup open, notification handler cancelled"):(alarmRunning=!0,console.group("Modation :: Check notifications"),console.time("Modation feed notifications"),m?$.get("http://soundation.com/feed",function(a){function c(a){var t=a["watchlist-queue"].length,
m=s+t,b="";if(s){var r=[];w.find("a.author").each(function(){author=$(this).text();-1==r.indexOf(author)&&r.push(author)});for(var e=r.length,f=e-3,b=e+" new from ",d=0;2>d&&d<e-1;++d)b+=r[d]+", ";b+=r[d];0<f&&(b+=", plus "+f+" other"+(1<f?"s":""));-1==hashes.indexOf(u)&&a.desktop_notifs&&chrome.notifications.create(u,{type:"basic",iconUrl:"img/iconapp.png",title:"Soundation Notifications",message:s+" new notification"+(1<parseInt(s)?"s":""),contextMessage:b.replace(/\d* new /,"")},function(b){hashes.push(u)})}t&&
(b+=(b?"\n":"")+t+" new from watchlist");m?crapi.badge({title:b,color:"red",text:String(m)}):(b="No new notifications :(",crapi.badge({title:b,text:""}));return b}a=a.replace(/<img\b[^>]*>/ig,"").replace(/<span class=\"time\">.*<\/span>/ig,"");a=$(a);var w=a.find("aside"),u="",s=0;w.length?(u=String(w[0].outerHTML.hashCode()),a=a.find("a[href='/feed']")[0].innerText,s=parseInt(a.match(/(\d+)/))||0):console.warn("Unable to parse feed notifications, continuing to watchlist");a=c(n[m.email]);console.log("Initial alerts:",
a);console.timeEnd("Modation feed notifications");console.time("Modation watchlist");$.get("http://soundation.com/account/profile",function(a){a=$(a).find(".public-url").text().replace("http://soundation.com","");m.profile=a;check_watchlist(m,!0,function(a){a=c(a);console.log("Re-generated alerts:",a);console.timeEnd("Modation watchlist");console.groupEnd();alarmRunning=!1})})}):(console.warn("Could not login to Soundation"),console.timeEnd("Modation feed notifications"),console.groupEnd(),crapi.badge({title:"Please login to view notifications",
color:"gray",text:"?"}),alarmRunning=!1)))})})});
function check_watchlist(a,c,n){"undefined"==typeof c&&(c=!0);"undefined"==typeof n&&(n=function(){});var m=a.email;console.group("Modation :: Check watchlist");var x=[];crapi.clone(function(v){function w(){console.groupCollapsed("Iterating watchlist...");var t=[];$.each(x,function(c,b){var r=b.link,e=$(b.html),f={},d={state:{}};delete b.html;var g=r.match(/user\/.*\/track\//)?!0:!1,k=r.match(/group\/.*/)?!0:!1,p=e.find(".comment .actions").children(".flag, .delete").first();g?(f.title=e.find("#main .title").text(),
f.likes=e.find(".stats .likes").text(),f.downloads=e.find(".stats .downloads").text()):k&&(f.title=e.find("#group-info h2").html(),(e=e.find("#group-info .info").text())?(f.members=e.match(/(\d*) member/)[1],f.following=e.match(/(\d*) follower/)[1]):console.warn("Network change detected, skipping group parse"));if(p.length){var h;switch(p.attr("class")){case "flag":h=p.attr("onclick");break;case "delete":h=p.attr("href")}"undefined"!=typeof h&&(f.comment=h.match(/(\d+)/g)[0],h=a.profile,p=p.parents(".comment").find("h4 a").attr("href"),
h==p&&(console.info("Detected self-comment, bypassing queue for "+f.title),v[m].watchlist[c].comment=f.comment))}e=f.title;k=f.likes;g=f.downloads;h=f.members;p=f.following;f=f.comment;d.changes=[];e&&(d.title=e,d.state.title=e);if(k&&b.likes!=k){var q=k-b.likes,n=q;0<q&&(n="+"+q);d.state.likes=k;e="undefined"==typeof b.likes;if(!isNaN(q)||e)e&&(q=n=k),d.likes=n+" like"+(1<Math.abs(q)||0==q?"s":""),d.changes.push(n+" like"+(1<Math.abs(q)||0==q?"s":""))}g&&b.downloads!=g&&(k=g-b.downloads,q="+"+k,
d.state.downloads=g,e="undefined"==typeof b.downloads,!isNaN(k)||e)&&(e&&(k=q=g),d.downloads=q+" download"+(1!==k?"s":""),d.changes.push(q+" download"+(1!==k?"s":"")));h&&b.members!=h&&(k=g=h-b.members,0<g&&(k="+"+g),d.state.members=h,e="undefined"==typeof b.members,!isNaN(g)||e)&&(e&&(g=k=h),d.members=k+" member"+(1<Math.abs(g)||0==g?"s":""),d.changes.push(k+" member"+(1<Math.abs(g)||0==g?"s":"")));p&&b.following!=p&&(g=h=p-b.following,0<h&&(g="+"+h),d.state.following=p,e="undefined"==typeof b.following,
isNaN(h)&&"undefined"!=typeof b.following||(e&&(h=g=p),d.following=g+" follower"+(1<Math.abs(h)||0==h?"s":""),d.changes.push(g+" follower"+(1<Math.abs(h)||0==h?"s":""))));f&&b.comment!=f&&(d.comment="New comment",d.changes.push("New comment"),d.state.comment=f);d.changes.length&&(d.link=r,d.index=c,t.push(d));console.log("Parsed item %s: %O",r,d)});console.groupEnd();v[m]["watchlist-queue"]=t;$.each(t,function(a,b){var c=String(JSON.stringify(b).hashCode());-1==hashes.indexOf(c)&&chrome.notifications.create(c,
{type:"basic",iconUrl:"img/iconapp.png",title:"Modation Watchlist",message:b.title,contextMessage:b.changes.join(", ")},function(a){hashes.push(c)})});console.groupEnd();c?crapi.update(m,v[m],n):n(v[m])}var u=v[m].watchlist,s=u.length,y=0;console.group("Queueing watchlist...");$.each(u,function(a,c){var b=c.link;$.get("http://soundation.com/"+b,function(b){c.html=b;x[a]=c}).fail(function(){c.fail=!0;x[a]=c}).done(function(){delete c.fail}).always(function(){console.log("Queued item %d of %d: %s",
++y,s,b);y==s&&(console.groupEnd(),w())})})})}function doNotifs(a){return"undefined"!=typeof a&&"on"!=localStorage[a+".desktop_notifs"]&&"off"==localStorage[a+".desktop_notifs"]?!1:!0};
