$(document).ready(function(){parseNotifs();initTabs()});function _factory(a){return $(".factory ."+a).clone()}function initTabs(){$("nav a").click(function(){$(this).parents("nav").find("a").removeClass("active");$(this).addClass("active");$(".main-wrapper .content").hide();var a=$(this).data("tab");$("#"+$(this).data("tab")+"-container").show();"modation-watchlist"==a&&parseWatchlist()});$("nav a:first").click()}
function parseNotifs(){$.get("http://soundation.com/feed",function(a){a=a.replace(/(<iframe\b.*?<\/iframe>)|(<img\b[^>]*>)/ig,"");var c=$(a).find("aside");c.attr("id","modation-notifications");var b=$("<strong>Unknown error</strong>");c.length?b=c:(chrome.browserAction.setTitle({title:"Please login to view notifications"}),chrome.browserAction.setBadgeBackgroundColor({color:"#9a9a9a"}),chrome.browserAction.setBadgeText({text:"?"}),b=$(_factory("modation-notifications-login")));$("#modation-notifications").replaceWith(b);
$("#modation-notifications a").each(function(){var a=$(this).attr("href");$(this).attr("href","http://soundation.com"+a);$(this).attr("target","_blank")});var e=0;$("#modation-notifications form[action*=clear_notification]").each(function(){var a=$(this).attr("action");$(this).attr("action","http://soundation.com"+a);$(this).attr("target","clearcatcher"+e);$("#content").after('<iframe width="0" height="0" name="clearcatcher'+e+'" style="display: none"></iframe>');++e});1<e&&($("#modation-notifications div.notifications h3").append('<span class="super clear-notification" id="superclear">Clear All</span>'),
$("#superclear").click(function(){$("#modation-notifications form[action*=clear_notification]").submit().parents("div.notifications div").slideUp();$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),$(this).fadeOut(),parseNotifs())}));$("#modation-notifications input.clear-notification").each(function(){$(this).click(function(){$(this).parents("div.notifications div").slideUp();
$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),parseNotifs())})});a=$(a).find("a[href='/feed']")[0].innerText.match(/(\d+)/);if(null!=a){var g=0,d=[];c.find("a.author").each(function(){author=$(this).text();-1==d.indexOf(author)&&d.push(author);++g});for(var c=d.length,b=c-3,h=0,f=g+" new from ",h=0;2>h&&h<c-1;++h)f+=d[h]+", ";f+=d[h];0<b&&(f+=", plus "+b+" other"+(1<b?"s":
""));console.log(f);chrome.browserAction.setTitle({title:f});chrome.browserAction.setBadgeBackgroundColor({color:"#d00"});chrome.browserAction.setBadgeText({text:a[0]})}else console.log("modation: no notifs"),chrome.browserAction.setTitle({title:"No new notifications :("}),chrome.browserAction.setBadgeText({text:""})})}
function parseWatchlist(){$("#modation-watchlist .loader").show();crapi.clone(function(a){console.log(a);modapi.login(function(c){console.log(c);$("#modation-watchlist").find(".modation-watchlist-item, .empty").remove();var b=a[c.email]["watchlist-queue"];b.length?$.each(b,function(a,b){$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-item").addClass("modation-watchlist-item-"+a));var d=$("#modation-watchlist .modation-watchlist-item-"+a);d.find(".item-title").html('<a href="http://soundation.com/'+
b.link+'" target="_blank">'+b.title);d.find(".item-body").html(b.changes.join(", "));d.find(".clear-notification").click(function(){console.log("clearing queue item "+a);clear_queue(c.email,a);$(this).parents(".notifications .modation-watchlist-item").slideUp(400,function(){$(this).remove();parseWatchlist()})})}):$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-empty"));$("#modation-watchlist .loader").hide()})})}
function clear_queue(a,c){crapi.clone(function(b){console.log("=============== BEFORE ============");var e=b[a]["watchlist-queue"][c],g=b[a].watchlist[e.index];console.log(e);console.log(g);for(var d in e.state)g[d]=e.state[d];console.log("============ AFTER ===============");console.log(g);b[a].watchlist[e.index]=g;b[a]["watchlist-queue"].splice(c,1);crapi.update(a,b[a],function(){console.log("cleared queue item "+c)})})};