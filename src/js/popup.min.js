$(document).ready(function(){parseNotifs();initTabs()});function _factory(a){return $(".factory ."+a).clone()}function initTabs(){$("nav a").click(function(){$(this).parents("nav").find("a").removeClass("active");$(this).addClass("active");$(".main-wrapper .content").hide();var a=$(this).data("tab");$("#"+$(this).data("tab")+"-container").show();"modation-watchlist"==a&&parseWatchlist()});$("nav a:first").click()}
function parseNotifs(){crapi.clone(function(a){modapi.login(function(b){var c=$("<strong>Unknown error</string>");b?$.get("http://soundation.com/feed",function(d){d=d.replace(/(<iframe\b.*?<\/iframe>)|(<img\b[^>]*>)/ig,"");d=$(d);var f=d.find("aside");f.attr("id","modation-notifications");d=d.find("a[href='/feed']")[0].innerText;var e=parseInt(d.match(/(\d+)/))||0;f&&(c=f);(function(a){a=a["watchlist-queue"].length;var d=e+a,b="";if(e){var c=[];f.find("a.author").each(function(){author=$(this).text();
-1==c.indexOf(author)&&c.push(author)});for(var g=c.length,k=g-3,b=g+" new from ",h=0;2>h&&h<g-1;++h)b+=c[h]+", ";b+=c[h];0<k&&(b+=", plus "+k+" other"+(1<k?"s":""))}a&&(b+=(b?"\n":"")+a+" new from watchlist");d?crapi.badge({title:b,color:"red",text:String(d)}):crapi.badge({title:"No new notifications :(",text:""})})(a[b.email]);$("#modation-notifications").replaceWith(c);$("#modation-notifications a").each(function(){var a=$(this).attr("href");$(this).attr("href","http://soundation.com"+a);$(this).attr("target",
"_blank")});var g=0;$("#modation-notifications form[action*=clear_notification]").each(function(){var a=$(this).attr("action");$(this).attr("action","http://soundation.com"+a);$(this).attr("target","clearcatcher"+g);$("#content").after('<iframe width="0" height="0" name="clearcatcher'+g+'" style="display: none"></iframe>');++g});1<g&&($("#modation-notifications div.notifications h3").append('<span class="super clear-notification" id="superclear">Clear All</span>'),$("#superclear").click(function(){$("#modation-notifications form[action*=clear_notification]").submit().parents("div.notifications div").slideUp();
$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),$(this).fadeOut(),parseNotifs())}));$("#modation-notifications input.clear-notification").each(function(){$(this).click(function(){$(this).parents("div.notifications div").slideUp();$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),
parseNotifs())})})}):(crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"}),c=$(_factory("modation-notifications-login")),$("#modation-notifications").replaceWith(c))})})}
function parseWatchlist(){$("#modation-watchlist .loader").show();crapi.clone(function(a){modapi.login(function(b){$("#modation-watchlist").find(".clear-notification, .modation-watchlist-item, .empty").remove();var c=a[b.email]["watchlist-queue"];c.length?($.each(c,function(a,c){$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-item").addClass("modation-watchlist-item-"+a));var e=$("#modation-watchlist .modation-watchlist-item-"+a);e.find(".item-title").html('<a href="http://soundation.com/'+
c.link+'" target="_blank">'+c.title);e.find(".item-body").html(c.changes.join(", "));e.find(".clear-notification").click(function(){clear_queue(b.email,a);$(this).parents(".notifications .modation-watchlist-item").slideUp(400,function(){$(this).remove();parseWatchlist()})})}),1<$("#modation-watchlist .modation-watchlist-item").length&&$("#modation-watchlist .modation-watchlist-header").append(_factory("modation-watchlist-clear-all").click(function(){purge_queue(b.email);$("#modation-watchlist .modation-watchlist-item").slideUp(400,
function(){$(this).remove();parseWatchlist()})}))):$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-empty"));$("#modation-watchlist .loader").hide()})})}function clear_queue(a,b){crapi.clone(function(c){var d=c[a]["watchlist-queue"][b],f=c[a].watchlist[d.index],e;for(e in d.state)f[e]=d.state[e];c[a].watchlist[d.index]=f;c[a]["watchlist-queue"].splice(b,1);crapi.update(a,c[a])})}
function purge_queue(a){crapi.clone(function(b){$.each(b[a]["watchlist-queue"],function(c,d){var f=b[a].watchlist[d.index],e;for(e in d.state)f[e]=d.state[e];b[a].watchlist[d.index]=f});b[a]["watchlist-queue"]=[];crapi.update(a,b[a])})}
crapi.debug&&(_wItem=function(){$("#modation-watchlist").find(".empty").remove();$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-item").addClass("modation-watchlist-item-debug"));var a=$("#modation-watchlist .modation-watchlist-item-debug").last();a.find(".item-title").html('<a href="#">Debug Item</a>');a.find(".item-body").html("Body, Mind, Soul")});
