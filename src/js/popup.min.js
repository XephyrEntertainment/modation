$(document).ready(function(){parseNotifs2();initTabs()});function _factory(c){return $(".factory ."+c).clone()}function initTabs(){$("nav a").click(function(){$(this).parents("nav").find("a").removeClass("active");$(this).addClass("active");$(".main-wrapper .content").hide();var c=$(this).data("tab");$("#"+$(this).data("tab")+"-container").show();"modation-watchlist"==c&&parseWatchlist()});$("nav a:first").click()}
function parseNotifs2(){crapi.clone(function(c){console.log(c);modapi.login(function(a){console.log(a);a?$.get("http://soundation.com/feed",function(b){b=b.replace(/(<iframe\b.*?<\/iframe>)|(<img\b[^>]*>)/ig,"");b=$(b);var f=b.find("aside");f.attr("id","modation-notifications");var g=$("<strong>Unknown error</string>");b=b.find("a[href='/feed']")[0].innerText;var d=parseInt(b.match(/(\d+)/))||0,g=f.length?f:$(_factory("modation-notifications-login"));(function(b){b=b["watchlist-queue"].length;var c=
d+b,a="";if(d){var g=[];f.find("a.author").each(function(){author=$(this).text();-1==g.indexOf(author)&&g.push(author)});for(var e=g.length,l=e-3,a=e+" new from ",k=0;2>k&&k<e-1;++k)a+=g[k]+", ";a+=g[k];0<l&&(a+=", plus "+l+" other"+(1<l?"s":""));console.log(a)}else console.log("modation: no notifs");b&&(a+=(a?"\n":"")+b+" new from watchlist");c?crapi.badge({title:a,color:"red",text:String(c)}):crapi.badge({title:"No new notifications :(",text:""})})(c[a.email]);$("#modation-notifications").replaceWith(g);
$("#modation-notifications a").each(function(){var a=$(this).attr("href");$(this).attr("href","http://soundation.com"+a);$(this).attr("target","_blank")});var e=0;$("#modation-notifications form[action*=clear_notification]").each(function(){var a=$(this).attr("action");$(this).attr("action","http://soundation.com"+a);$(this).attr("target","clearcatcher"+e);$("#content").after('<iframe width="0" height="0" name="clearcatcher'+e+'" style="display: none"></iframe>');++e});1<e&&($("#modation-notifications div.notifications h3").append('<span class="super clear-notification" id="superclear">Clear All</span>'),
$("#superclear").click(function(){$("#modation-notifications form[action*=clear_notification]").submit().parents("div.notifications div").slideUp();$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),$(this).fadeOut(),parseNotifs2())}));$("#modation-notifications input.clear-notification").each(function(){$(this).click(function(){$(this).parents("div.notifications div").slideUp();
$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),parseNotifs2())})})}):crapi.badge({title:"Please login to view notifications",color:"gray",text:"?"})})})}
function parseNotifs(){$.get("http://soundation.com/feed",function(c){c=c.replace(/(<iframe\b.*?<\/iframe>)|(<img\b[^>]*>)/ig,"");var a=$(c).find("aside");a.attr("id","modation-notifications");var b=$("<strong>Unknown error</strong>");a.length?b=a:(chrome.browserAction.setTitle({title:"Please login to view notifications"}),chrome.browserAction.setBadgeBackgroundColor({color:"#9a9a9a"}),chrome.browserAction.setBadgeText({text:"?"}),b=$(_factory("modation-notifications-login")));$("#modation-notifications").replaceWith(b);
$("#modation-notifications a").each(function(){var a=$(this).attr("href");$(this).attr("href","http://soundation.com"+a);$(this).attr("target","_blank")});var f=0;$("#modation-notifications form[action*=clear_notification]").each(function(){var a=$(this).attr("action");$(this).attr("action","http://soundation.com"+a);$(this).attr("target","clearcatcher"+f);$("#content").after('<iframe width="0" height="0" name="clearcatcher'+f+'" style="display: none"></iframe>');++f});1<f&&($("#modation-notifications div.notifications h3").append('<span class="super clear-notification" id="superclear">Clear All</span>'),
$("#superclear").click(function(){$("#modation-notifications form[action*=clear_notification]").submit().parents("div.notifications div").slideUp();$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),$(this).fadeOut(),parseNotifs())}));$("#modation-notifications input.clear-notification").each(function(){$(this).click(function(){$(this).parents("div.notifications div").slideUp();
$("#modation-notifications div.notifications h3 img").length||($("#modation-notifications div.notifications h3").append('<img src="img/loading.gif" style="float: right">'),parseNotifs())})});c=$(c).find("a[href='/feed']")[0].innerText.match(/(\d+)/);if(null!=c){var g=0,d=[];a.find("a.author").each(function(){author=$(this).text();-1==d.indexOf(author)&&d.push(author);++g});for(var a=d.length,b=a-3,e=0,h=g+" new from ",e=0;2>e&&e<a-1;++e)h+=d[e]+", ";h+=d[e];0<b&&(h+=", plus "+b+" other"+(1<b?"s":
""));console.log(h);chrome.browserAction.setTitle({title:h});chrome.browserAction.setBadgeBackgroundColor({color:"#d00"});chrome.browserAction.setBadgeText({text:c[0]})}else console.log("modation: no notifs"),chrome.browserAction.setTitle({title:"No new notifications :("}),chrome.browserAction.setBadgeText({text:""})})}
function parseWatchlist(){$("#modation-watchlist .loader").show();crapi.clone(function(c){console.log(c);modapi.login(function(a){console.log(a);$("#modation-watchlist").find(".modation-watchlist-item, .empty").remove();var b=c[a.email]["watchlist-queue"];b.length?$.each(b,function(b,c){$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-item").addClass("modation-watchlist-item-"+b));var d=$("#modation-watchlist .modation-watchlist-item-"+b);d.find(".item-title").html('<a href="http://soundation.com/'+
c.link+'" target="_blank">'+c.title);d.find(".item-body").html(c.changes.join(", "));d.find(".clear-notification").click(function(){console.log("clearing queue item "+b);clear_queue(a.email,b);$(this).parents(".notifications .modation-watchlist-item").slideUp(400,function(){$(this).remove();parseWatchlist()})})}):$("#modation-watchlist .wrapper").append(_factory("modation-watchlist-empty"));$("#modation-watchlist .loader").hide()})})}
function clear_queue(c,a){crapi.clone(function(b){var f=b[c]["watchlist-queue"][a],g=b[c].watchlist[f.index],d;for(d in f.state)g[d]=f.state[d];b[c].watchlist[f.index]=g;b[c]["watchlist-queue"].splice(a,1);crapi.update(c,b[c],function(){console.log("cleared queue item "+a)})})};
